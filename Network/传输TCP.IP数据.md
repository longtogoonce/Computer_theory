# 创建套接字
## 2.1协议栈的内部结构
> 协议栈的上半部分有两块：
> - 一部分以TCP协议来收发数据（浏览器，邮件等应用程序）
> - 一部分以UDP协议收发数据（DNS查询）
> 
>  协议栈的下一部分为IP协议：
> - IP协议负责控制网络包收发操作，在互联网中传输数据时，数据会被切割为一个一个的网络包
## 2.2套接字的实体
> 协议栈内部有一块用于存放控制信息的内存空间，记录了用于控制通信操作的控制信息，例如：IP地址，端口号，通信操作的状态
> 
> 套接字本就是一个概念而已，但我们可以理解为控制信息就是套接字实体
>
> 协议栈是根据套接字中记录的控制信息来工作的
## 2.3控制信息
> 在连接阶段，网络包中只有控制信息
>
>控制信息包括：
> - 以太网和IP的控制信息
> - TCP的控制信息
> 
> TCP的部分格式:
> - 发送与接受端口号
> - 数据顺序编号
> - ACK号
> - 数据偏移量
> - 控制位
> - 窗口
>
> 通信操作的控制信息分为两类：
> - 头部中记录的信息
> - 套接字中记录的信息
## 2.4建立连接的过程
> 1.在客户端的TCP模块创建表示连接的控制信息的头部\
> 2.将数据传递给IP模块并委托其进行发送\
> 3.网络包通过网络到达服务器\
> 4.服务器的TCP模块根据TCP头部的信息找到对应的套接字\
> 5.套接字写入相应的信息，表示正在连接\
> 6.服务器的TCP模块将TCP头部传递给IP模块，并委托IP模块向客户端返回响应
> 7.客户端确认连接状态，套接字进入随时收发数据的状态
## 2.5收发数据
> 协议栈会因为数据的长度以及计数器来把网络包发送出去
>
> 使用ACK号来确认网络包已收到
> - ACK号用于确认已经成功接收到数据的包的序号
> - ACK号还可以用于实现TCP的流量控制和拥塞控制
> 
> 控制位：
> - SYN包是由客户端发送给服务器的，用于请求建立连接并传输起始序号，而服务器在回复客户端时会发送一个ACK包，表示确认收到了客户端的SYN包，并在该ACK包中发送自己的序列号。此时，客户端再回复一个ACK包，表示确认收到服务器的确认，并发送下一个序列号。
> - FIN包则用于关闭连接。当一个端点发送FIN包时，它表示该端点已经完成了数据的发送，希望关闭连接。收到FIN包的另一个端点会发送一个ACK包表示已经收到了该FIN包。然后，它也可以发送一个FIN包来关闭连接，也可以继续发送数据直到自己准备好关闭连接。
>
> 窗口：
> - TCP采用滑动窗口来管理数据发送与ACK号操作（在等待时间中继续发包）
> - 接收方的TCP收到包后，数据会被放在缓冲区中，然后计算ACK包，将数据组装成原始的数据并传递给应用程序
## 3.6IP与以太网的包收发操作
> 1.主要流程：
> 
> - 每个IP地址都由网络地址和主机地址组成。
> - 当一个计算机向另一个计算机发送数据时，数据会先到达该计算机所在的子网的集线器，
> - 然后通过路由器发送到目标计算机所在的子网。
> - 路由器会根据IP地址中的网络地址找到对应的子网，然后将数据发送到该子网的集线器。
> - 集线器会根据数据中的MAC地址找到对应的目标计算机。
>
> 2.集线器的作用：
>
> - 集线器主要作用是把数据发送给所有连接的计算机，如果该数据包的MAC地址与该计算机的地址符合，那么该计算机将会接受该数据
> - MAC地址帮助数据在到达对应的子网时可以找到对应IP地址中的主机地址
>
> 3.路由器的作用：
>
> - 路由器的主要作用是将数据在不同的子网中传递，每一个路由器都有一个IP地址，通过查询该表，将数据发给下一个地址
>
> 4.协议栈中IP区块的作用：
> - 添加MAC头部，以太网的头部，包含MAC地址
> - 添加IP头部，IP用的头部，包含IP地址
>
> 5.路由表：
> - 对套接字中记录的目标IP地址与路由表的Network Destination比较
> - 若找到，则通过对应的网卡等网络接口将数据发送出去
> - 若没有找到，则通过记录的默认地址发送数据
> 
> 6.网卡的作用：
> - 传递给网卡的网络包是由一串01数字信息，网卡会将这些数字信息转换为电信号或光信号，并通过网线(光纤)发送出去
>
> 7.网关的作用：
> - 网关通常也被称为路由器，因为它们都具有将数据包在不同网络中传递的能力。
> - 但是，与普通路由器相比，网关通常具有更多的功能，例如地址转换、协议转换和负载均衡等。
> - 这些功能使得网关可以在不同的网络之间进行数据传输，同时确保数据的正确传输和格式转换。
>
> 8.通过ARP查询目标路由器的MAC地址
> - 在以太网中，ARP通过广播的方式对所有设备发送匹配消息，然后得到对方的MAC地址
> - ARP具有缓存机制，数据一般保留几分钟
> 9.IP地址与MAC地址的区别
> - IP地址是属于网络层协议，用于在不同的网络之间进行路由选择和数据包转发。在同一个局域网中，数据包不需要经过路由器进行转发，而是直接在局域网内进行传输，因此需要使用数据链路层协议来标识不同的计算机。
> ## 3.7以太网基本知识
> 1.以太网结构
> - 以太网原型：通过一根主干网线连接所有的计算机，所以这种结构会让信号流过所有的网络，到每一台设备，所以需要通过MAC地址判断是谁的
> - 中继式集线器的变体：采用双绞线
> - 交换式集线器：信号只会流到指定的MAC地址
> - - -
> 2.IP包转换为电与光信号
> 
> - IP生成的网络包只是放在内存中的数字信号，所以需要网卡以及网卡驱动装置，将数字信号转化为电或光信号
> - 工作流程：启动操作系统，网卡驱动程序会对硬件进行初始化(硬件错误检查，初始设置等)，同时会读取网卡的ROM中保存的唯一的MAC地址，在MAC模块中设置MAC地址，之后网卡就可以等待来自IP的委托了
> - 工作组成：应用程序 -> 协议栈 ->  网卡驱动 ->  扩展总线接口 ->  网卡
> - - 扩展总线接口：（PCI Express）是一种高速串行总线接口，主要用于连接计算机的主板和扩展设备，如网卡、显卡、声卡等。其主要作用是提供高速、可靠、低延迟的数据传输通道，以支持高性能计算和数据传输应用。
>
> - - 网卡：缓冲区 -> MAC模块 -> PHY(MAU)模块 ->  LAN网线
> - - -  工作流程：网卡的MAC模块生成通用信号，然后由PHY(MAU)模块转换可在网线中传输的格式，并通过网线发送出去
> - - - 缓存区：临时保存要收发的内存空间
> - - -  MAC区块：读取MAC地址，控制碰撞检测，重发
> - - - PHY：收发信号的电路
> - - - 
> 3.网卡工作内容
> - MAC模块会从缓冲区中取出网络包，然后加上报头，起始帧分界符，以及FCS(帧校验序列)
> - - 报头：为了识别数据信号，所以加入时钟信号，所以报头的作用就是测量时钟信号
> - - 起始帧分界符：接收方以此为标记，开始提取数据
> - - FCS：通过一个计算公式，判断数据是否出现问题
> - 向集线器发送网络包
> - - 一种是集线器的半双工模式
> - - 一种是交换机的全双工模式
>
> # 总结：
> 当网络应用程序需要向服务器发送数据包时，应用程序会调用Socket库进行网络通信，然后操作系统会读取这个请求，并将其传递给协议栈。协议栈包括网络层、传输层和应用层协议，其中网络层负责将数据包从源节点传输到目标节点，而传输层则负责提供端到端的可靠数据传输服务。
> 
> 在传输层中，TCP和UDP是两种常用的协议。TCP协议提供的是基于连接的可靠数据传输服务，需要进行三次握手建立连接，而UDP协议则是无连接的，不保证数据传输的可靠性。
> 
>网络层中，IP协议是最常用的协议，它负责将数据包从源节点传输到目标节点。在IP协议中，会添加IP头部，其中包括源IP地址和目标IP地址等信息，用于标识数据包传输的源节点和目标节点。此外，还有一些其他的字段，例如TTL和协议字段等。
>
>最后，数据包会进入网卡的缓冲区，在这里进行一些数据的处理和缓存，然后通过MAC区块添加MAC头部和报头等内容。随后，数据包进入网卡的PHY区块，在这个区块中进行调制和编码等操作，将数据包转换为可在物理介质（如网线）中传输的形式，并通过物理介质发送出去。
>
>总之，网络通信涉及到多个协议层次的处理和操作，其中协议栈包括网络层、传输层和应用层协议，而在物理网络中还需要进行MAC头部和PHY层的处理和操作。
                      